name: CI

on:
  push:
    paths:
      - 'scripts/**'
      - 'tests/**'
      - 'action.yml'
      - '.github/workflows/ci.yaml'
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-scripts:
    name: Test Scripts (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, macos-14, windows-2022]
    steps:
      # v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Setup Nu shell
        # v3.17
        uses: hustcer/setup-nu@920172d92eb04671776f3ba69d605d3b09351c30
        with:
          version: '0.110.0'

      - name: Run Nu shell unit tests
        shell: nu {0}
        run: nu tests/run.nu

      - name: Test get-version (package)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "[package]\nname = \"test-pkg\"\nversion = \"1.2.3\"" | save -f Cargo.toml
          $env.MANIFEST_PATH = "Cargo.toml"
          let output = nu scripts/get-version.nu | str trim
          if $output != "1.2.3" {
              print $"error: expected '1.2.3', got '($output)'"
              exit 1
          }

      - name: Test get-version (workspace)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "[workspace]\nmembers = []\n\n[workspace.package]\nversion = \"2.0.0\"" | save -f Cargo.toml
          $env.MANIFEST_PATH = "Cargo.toml"
          let output = nu scripts/get-version.nu | str trim
          if $output != "2.0.0" {
              print $"error: expected '2.0.0', got '($output)'"
              exit 1
          }

      - name: Test get-version (invalid format)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "[package]\nname = \"test\"\nversion = \"bad\"" | save -f Cargo.toml
          $env.MANIFEST_PATH = "Cargo.toml"
          let result = do { nu scripts/get-version.nu } | complete
          if $result.exit_code == 0 {
              print "error: should have failed on invalid version"
              exit 1
          }

      - name: Test extract-changelog
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "# Changelog\n\n## v1.0.0 (Jan 1, 2026)\n\n### Enhancements\n- Added feature X\n\n## v0.9.0 (Dec 1, 2025)\n\n- First version" | save -f CHANGELOG.md
          $env.VERSION = "1.0.0"
          $env.CHANGELOG_PATH = "CHANGELOG.md"
          $env.OUTPUT_PATH = "notes.md"
          nu scripts/extract-changelog.nu
          let notes = open notes.md
          if not ($notes | str contains "## v1.0.0") {
              print "error: missing version header"
              exit 1
          }
          if not ($notes | str contains "Added feature X") {
              print "error: missing expected content"
              exit 1
          }
          if ($notes | str contains "First version") {
              print "error: should not contain previous version"
              exit 1
          }

      - name: Test extract-changelog (last version in file)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "# Changelog\n\n## v1.0.0 (Jan 1, 2026)\n\n- Only version content" | save -f CHANGELOG.md
          $env.VERSION = "1.0.0"
          $env.CHANGELOG_PATH = "CHANGELOG.md"
          $env.OUTPUT_PATH = "notes.md"
          nu scripts/extract-changelog.nu
          let notes = open notes.md
          if not ($notes | str contains "Only version content") {
              print "error: missing content from last version"
              exit 1
          }

      - name: Test extract-changelog (version not found)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "# Changelog\n\n## v1.0.0 (Jan 1, 2026)\n\n- Content" | save -f CHANGELOG.md
          $env.VERSION = "9.9.9"
          $env.CHANGELOG_PATH = "CHANGELOG.md"
          let result = do { nu scripts/extract-changelog.nu } | complete
          if $result.exit_code == 0 {
              print "error: should have failed for missing version"
              exit 1
          }

      - name: Test extract-changelog (without v prefix)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          "# Changelog\n\n## 1.0.0 (Jan 1, 2026)\n\n- Feature without v prefix" | save -f CHANGELOG.md
          $env.VERSION = "1.0.0"
          $env.CHANGELOG_PATH = "CHANGELOG.md"
          $env.OUTPUT_PATH = "notes.md"
          nu scripts/extract-changelog.nu
          let notes = open notes.md
          if not ($notes | str contains "Feature without v prefix") {
              print "error: failed to extract changelog without v prefix"
              exit 1
          }

      - name: Test validate-version (match)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          $env.TAG = "v1.2.3"
          $env.EXPECTED_VERSION = "1.2.3"
          nu scripts/validate-version.nu

      - name: Test validate-version (mismatch)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          $env.TAG = "v1.2.3"
          $env.EXPECTED_VERSION = "1.2.4"
          let result = do { nu scripts/validate-version.nu } | complete
          if $result.exit_code == 0 {
              print "error: should have failed on version mismatch"
              exit 1
          }

      - name: Test validate-version (invalid tag)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          $env.TAG = "1.2.3"
          $env.EXPECTED_VERSION = "1.2.3"
          let result = do { nu scripts/validate-version.nu } | complete
          if $result.exit_code == 0 {
              print "error: should have failed on tag without v prefix"
              exit 1
          }

      - name: Test validate-version (pre-release)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          $env.TAG = "v1.0.0-beta.1"
          $env.EXPECTED_VERSION = "1.0.0-beta.1"
          nu scripts/validate-version.nu

      - name: Test validate-version (build metadata)
        shell: nu {0}
        run: |
          $env.NU_LIB_DIRS = ["scripts"]
          $env.TAG = "v1.0.0+build.123"
          $env.EXPECTED_VERSION = "1.0.0+build.123"
          nu scripts/validate-version.nu

  test-action:
    name: Test Action
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      # v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Create test files
        run: |
          cat > Cargo.toml << 'EOF'
          [package]
          name = "test-project"
          version = "0.5.0"
          EOF

          cat > CHANGELOG.md << 'EOF'
          # Changelog

          ## v0.5.0 (Jan 31, 2026)

          ### Enhancements
          - New feature added

          ## v0.4.0 (Jan 1, 2026)

          - Previous release
          EOF

      - name: Test get-version
        uses: ./
        id: version
        with:
          command: get-version

      - name: Verify get-version output
        run: |
          if [ "${{ steps.version.outputs.version }}" != "0.5.0" ]; then
            echo "error: expected '0.5.0', got '${{ steps.version.outputs.version }}'"
            exit 1
          fi

      - name: Test extract-changelog
        uses: ./
        with:
          command: extract-changelog
          version: '0.5.0'

      - name: Verify extract-changelog output
        run: |
          if ! grep -q "## v0.5.0" release_notes.md; then
            echo "error: missing version header"
            exit 1
          fi
          if ! grep -q "New feature added" release_notes.md; then
            echo "error: missing expected content"
            exit 1
          fi
          if grep -q "Previous release" release_notes.md; then
            echo "error: should not contain previous version content"
            exit 1
          fi

      - name: Test validate-version
        uses: ./
        id: validate
        with:
          command: validate-version
          tag: v0.5.0
          expected-version: '0.5.0'

      - name: Verify validate-version output
        run: |
          if [ "${{ steps.validate.outputs.version }}" != "0.5.0" ]; then
            echo "error: expected '0.5.0', got '${{ steps.validate.outputs.version }}'"
            exit 1
          fi
