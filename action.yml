name: 'Rust Build, Package and Release Action'
description: 'Rust releases: cross-platform builds, packaging, SBOM generation, change log support'
author: 'Michael Klishin'

branding:
  icon: 'package'
  color: 'orange'

inputs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Core inputs - universal options used across commands
  # ─────────────────────────────────────────────────────────────────────────────
  command:
    description: 'Command to run'
    required: true
  version:
    description: 'Version (without v prefix)'
    required: false
  target:
    description: 'Rust target triple (e.g., x86_64-unknown-linux-gnu)'
    required: false
  binary-name:
    description: 'Binary name (defaults to package name from Cargo.toml)'
    required: false
  package:
    description: 'Cargo package name (for workspace builds)'
    required: false
  manifest:
    description: 'Path to Cargo.toml'
    required: false
    default: 'Cargo.toml'
  working-directory:
    description: 'Working directory for commands'
    required: false
    default: '.'

  # ─────────────────────────────────────────────────────────────────────────────
  # Build options - standard Cargo build flags
  # ─────────────────────────────────────────────────────────────────────────────
  pre-build:
    description: 'Shell command to run before cargo build (e.g., frontend build step)'
    required: false
  skip-build:
    description: 'Skip cargo build and use existing binary (for container/Alpine workflows)'
    required: false
    default: 'false'
  binary-path:
    description: 'Path to existing binary when skip-build is true'
    required: false
  features:
    description: 'Cargo features to enable (comma-separated)'
    required: false
  profile:
    description: 'Cargo build profile'
    required: false
    default: 'release'
  locked:
    description: 'Build with --locked for reproducible builds'
    required: false
    default: 'false'
  no-default-features:
    description: 'Build with --no-default-features'
    required: false
    default: 'false'
  rustflags:
    description: 'Extra RUSTFLAGS for the build'
    required: false
  use-zigbuild:
    description: 'Use cargo-zigbuild for cross-compilation (e.g., musl targets)'
    required: false
    default: 'false'

  # ─────────────────────────────────────────────────────────────────────────────
  # Output options - control artifact generation
  # ─────────────────────────────────────────────────────────────────────────────
  archive:
    description: 'Create archive (.tar.gz on Linux/macOS, .zip on Windows)'
    required: false
    default: 'false'
  checksum:
    description: 'Checksum algorithms (sha256, sha512, b2)'
    required: false
    default: 'sha256'
  include:
    description: 'Extra files to include in archive (glob patterns, comma-separated)'
    required: false

  # ─────────────────────────────────────────────────────────────────────────────
  # Changelog options - for extract-changelog command
  # ─────────────────────────────────────────────────────────────────────────────
  changelog:
    description: 'Path to CHANGELOG.md'
    required: false
    default: 'CHANGELOG.md'
  notes-output:
    description: 'Output file for extracted release notes'
    required: false
    default: 'release_notes.md'

  # ─────────────────────────────────────────────────────────────────────────────
  # Version validation - for validate-version command
  # ─────────────────────────────────────────────────────────────────────────────
  tag:
    description: 'Git tag to validate (defaults to GITHUB_REF_NAME)'
    required: false
  expected-version:
    description: 'Expected version (defaults to NEXT_RELEASE_VERSION variable)'
    required: false
  validate-cargo-toml:
    description: 'Also validate that Cargo.toml version matches the tag'
    required: false
    default: 'false'

  # ─────────────────────────────────────────────────────────────────────────────
  # Package metadata (pkg-*) - shared across deb/rpm/apk/brew/aur/winget
  # ─────────────────────────────────────────────────────────────────────────────
  pkg-description:
    description: 'Package description'
    required: false
  pkg-maintainer:
    description: 'Package maintainer (format: Name <email>)'
    required: false
  pkg-homepage:
    description: 'Project homepage URL'
    required: false
  pkg-license:
    description: 'License identifier (e.g., MIT, Apache-2.0)'
    required: false
  pkg-vendor:
    description: 'Vendor/organization name'
    required: false
  pkg-depends:
    description: 'Runtime dependencies (comma-separated)'
    required: false
  pkg-recommends:
    description: 'Recommended packages (comma-separated)'
    required: false
  pkg-suggests:
    description: 'Suggested packages (comma-separated)'
    required: false
  pkg-conflicts:
    description: 'Conflicting packages (comma-separated)'
    required: false
  pkg-replaces:
    description: 'Packages this replaces (comma-separated)'
    required: false
  pkg-provides:
    description: 'Virtual packages provided (comma-separated)'
    required: false
  pkg-contents:
    description: 'Extra files to include (format: src:dst,src:dst)'
    required: false
  pkg-section:
    description: 'Debian package section'
    required: false
    default: 'utils'
  pkg-priority:
    description: 'Debian package priority'
    required: false
    default: 'optional'
  pkg-group:
    description: 'RPM package group'
    required: false
    default: 'Applications/System'
  pkg-release:
    description: 'Package release/revision number'
    required: false

  # ─────────────────────────────────────────────────────────────────────────────
  # SBOM options (sbom-*) - for generate-sbom command
  # ─────────────────────────────────────────────────────────────────────────────
  sbom-format:
    description: 'SBOM formats to generate (spdx, cyclonedx, or both)'
    required: false
    default: 'spdx,cyclonedx'
  sbom-dir:
    description: 'Output directory for SBOM files'
    required: false
    default: 'target/sbom'

  # ─────────────────────────────────────────────────────────────────────────────
  # Homebrew options (brew-*) - for generate-homebrew command
  # ─────────────────────────────────────────────────────────────────────────────
  brew-class:
    description: 'Ruby class name for formula (auto-generated from binary name)'
    required: false
  brew-macos-arm64-url:
    description: 'Download URL for macOS ARM64 artifact'
    required: false
  brew-macos-arm64-sha256:
    description: 'SHA256 checksum for macOS ARM64 artifact'
    required: false
  brew-macos-x64-url:
    description: 'Download URL for macOS x64 artifact'
    required: false
  brew-macos-x64-sha256:
    description: 'SHA256 checksum for macOS x64 artifact'
    required: false
  brew-linux-arm64-url:
    description: 'Download URL for Linux ARM64 artifact'
    required: false
  brew-linux-arm64-sha256:
    description: 'SHA256 checksum for Linux ARM64 artifact'
    required: false
  brew-linux-x64-url:
    description: 'Download URL for Linux x64 artifact'
    required: false
  brew-linux-x64-sha256:
    description: 'SHA256 checksum for Linux x64 artifact'
    required: false
  brew-dir:
    description: 'Output directory for formula file'
    required: false
    default: 'target/homebrew'

  # ─────────────────────────────────────────────────────────────────────────────
  # Signing options - for sign-artifact command
  # ─────────────────────────────────────────────────────────────────────────────
  artifact:
    description: 'Path to artifact (for signing or testing)'
    required: false

  # ─────────────────────────────────────────────────────────────────────────────
  # Artifact collection options - for collect-artifacts command
  # ─────────────────────────────────────────────────────────────────────────────
  base-url:
    description: 'Base URL for artifact downloads (e.g., https://github.com/user/repo/releases/download/v1.0.0)'
    required: false

  # ─────────────────────────────────────────────────────────────────────────────
  # Release body options - for format-release command
  # ─────────────────────────────────────────────────────────────────────────────
  artifacts-dir:
    description: 'Directory containing release artifacts'
    required: false
    default: 'release'
  notes-file:
    description: 'Release notes file to include in body'
    required: false
    default: 'release_notes.md'
  include-checksums:
    description: 'Include checksums section in release body'
    required: false
    default: 'true'
  include-signatures:
    description: 'Include signatures section in release body'
    required: false
    default: 'true'
  homebrew-tap:
    description: 'Homebrew tap for installation instructions (e.g., user/tap/formula)'
    required: false
  aur-package:
    description: 'AUR package name for installation instructions'
    required: false
  winget-id:
    description: 'Winget package ID for installation instructions'
    required: false

  # ─────────────────────────────────────────────────────────────────────────────
  # AUR options (aur-*) - for generate-aur command
  # ─────────────────────────────────────────────────────────────────────────────
  aur-name:
    description: 'AUR package name (defaults to binary name)'
    required: false
  aur-maintainer:
    description: 'AUR maintainer (format: Name <email>)'
    required: false
  aur-source-url:
    description: 'Source tarball URL (usually GitHub release tarball)'
    required: false
  aur-source-sha256:
    description: 'SHA256 checksum of source tarball'
    required: false
  aur-makedepends:
    description: 'Build-time dependencies (comma-separated)'
    required: false
    default: 'cargo'
  aur-optdepends:
    description: 'Optional dependencies (comma-separated)'
    required: false
  aur-dir:
    description: 'Output directory for PKGBUILD and .SRCINFO'
    required: false
    default: 'target/aur'

  # ─────────────────────────────────────────────────────────────────────────────
  # Winget options (winget-*) - for generate-winget command
  # ─────────────────────────────────────────────────────────────────────────────
  winget-publisher:
    description: 'Publisher display name'
    required: false
  winget-publisher-id:
    description: 'Publisher ID (defaults to publisher name without spaces)'
    required: false
  winget-package-id:
    description: 'Package ID (defaults to binary name)'
    required: false
  winget-license-url:
    description: 'URL to license file'
    required: false
  winget-copyright:
    description: 'Copyright notice'
    required: false
  winget-tags:
    description: 'Package tags (comma-separated)'
    required: false
  winget-x64-url:
    description: 'Download URL for Windows x64 artifact'
    required: false
  winget-x64-sha256:
    description: 'SHA256 checksum for Windows x64 artifact'
    required: false
  winget-arm64-url:
    description: 'Download URL for Windows ARM64 artifact'
    required: false
  winget-arm64-sha256:
    description: 'SHA256 checksum for Windows ARM64 artifact'
    required: false
  winget-dir:
    description: 'Output directory for manifest files'
    required: false
    default: 'target/winget'

  # ─────────────────────────────────────────────────────────────────────────────
  # Artifact testing options - for test-deb, test-rpm, test-windows commands
  # ─────────────────────────────────────────────────────────────────────────────
  checksum-file:
    description: 'Path to checksum file (.sha256, .sha512, or .b2) for verification'
    required: false
  msi-path:
    description: 'Path to MSI installer (for test-windows)'
    required: false
  msi-checksum-file:
    description: 'Path to checksum file for MSI installer (for test-windows)'
    required: false
  download-from-release:
    description: 'Download artifacts from GitHub release instead of using local files'
    required: false
    default: 'false'
  arch:
    description: 'Architecture for artifact download (amd64, arm64, x86_64, aarch64)'
    required: false

outputs:
  version:
    description: 'Version from get-version, validate-version, or release commands'
    value: ${{ steps.run.outputs.version }}

  release_notes_file:
    description: 'Path to release notes file'
    value: ${{ steps.run.outputs.release_notes_file }}

  release_notes:
    description: 'Release notes content'
    value: ${{ steps.run.outputs.release_notes }}

  artifact:
    description: 'Artifact filename (archive when archive=true, bare binary otherwise)'
    value: ${{ steps.run.outputs.artifact }}

  artifact_path:
    description: 'Full path to artifact (archive when archive=true, bare binary otherwise)'
    value: ${{ steps.run.outputs.artifact_path }}

  bare_artifact:
    description: 'Bare binary filename (always produced)'
    value: ${{ steps.run.outputs.bare_artifact }}

  bare_artifact_path:
    description: 'Full path to bare binary (always produced)'
    value: ${{ steps.run.outputs.bare_artifact_path }}

  binary_name:
    description: 'Binary name that was built'
    value: ${{ steps.run.outputs.binary_name }}

  binary_path:
    description: 'Path to the raw binary (before archiving)'
    value: ${{ steps.run.outputs.binary_path }}

  target:
    description: 'Target triple used for the build'
    value: ${{ steps.run.outputs.target }}

  sha256:
    description: 'SHA256 checksum of the artifact'
    value: ${{ steps.run.outputs.sha256 }}

  sha512:
    description: 'SHA512 checksum of the artifact'
    value: ${{ steps.run.outputs.sha512 }}

  b2:
    description: 'BLAKE2 checksum of the artifact'
    value: ${{ steps.run.outputs.b2 }}

  checksum_file:
    description: 'Path to checksum file (.sha256)'
    value: ${{ steps.run.outputs.checksum_file }}

  summary:
    description: 'JSON summary of the build'
    value: ${{ steps.run.outputs.summary }}

  sbom_spdx:
    description: 'Path to SPDX SBOM file'
    value: ${{ steps.run.outputs.sbom_spdx }}

  sbom_cyclonedx:
    description: 'Path to CycloneDX SBOM file'
    value: ${{ steps.run.outputs.sbom_cyclonedx }}

  formula_file:
    description: 'Path to Homebrew formula file'
    value: ${{ steps.run.outputs.formula_file }}

  formula_class:
    description: 'Ruby class name of the Homebrew formula'
    value: ${{ steps.run.outputs.formula_class }}

  formula:
    description: 'Homebrew formula content'
    value: ${{ steps.run.outputs.formula }}

  signature_path:
    description: 'Path to signature file'
    value: ${{ steps.run.outputs.signature_path }}

  certificate_path:
    description: 'Path to signing certificate'
    value: ${{ steps.run.outputs.certificate_path }}

  bundle_path:
    description: 'Path to Sigstore bundle'
    value: ${{ steps.run.outputs.bundle_path }}

  body:
    description: 'Formatted release body'
    value: ${{ steps.run.outputs.body }}

  pkgbuild_path:
    description: 'Path to AUR PKGBUILD'
    value: ${{ steps.run.outputs.pkgbuild_path }}

  srcinfo_path:
    description: 'Path to AUR .SRCINFO'
    value: ${{ steps.run.outputs.srcinfo_path }}

  pkgbuild:
    description: 'AUR PKGBUILD content'
    value: ${{ steps.run.outputs.pkgbuild }}

  manifest_dir:
    description: 'Winget manifest directory'
    value: ${{ steps.run.outputs.manifest_dir }}

  manifest_id:
    description: 'Winget manifest ID'
    value: ${{ steps.run.outputs.manifest_id }}

  # collect-artifacts outputs
  collection:
    description: 'JSON collection of artifacts with checksums and URLs'
    value: ${{ steps.run.outputs.collection }}

  checksums_file:
    description: 'Path to consolidated SHA256SUMS file'
    value: ${{ steps.run.outputs.checksums_file }}

  macos_arm64_sha256:
    description: 'SHA256 of macOS ARM64 artifact'
    value: ${{ steps.run.outputs.macos_arm64_sha256 }}

  macos_x64_sha256:
    description: 'SHA256 of macOS x64 artifact'
    value: ${{ steps.run.outputs.macos_x64_sha256 }}

  linux_arm64_sha256:
    description: 'SHA256 of Linux ARM64 artifact'
    value: ${{ steps.run.outputs.linux_arm64_sha256 }}

  linux_x64_sha256:
    description: 'SHA256 of Linux x64 artifact'
    value: ${{ steps.run.outputs.linux_x64_sha256 }}

  windows_x64_sha256:
    description: 'SHA256 of Windows x64 artifact'
    value: ${{ steps.run.outputs.windows_x64_sha256 }}

  windows_arm64_sha256:
    description: 'SHA256 of Windows ARM64 artifact'
    value: ${{ steps.run.outputs.windows_arm64_sha256 }}

  result:
    description: 'Test result (success/failure) for test-* commands'
    value: ${{ steps.run.outputs.result }}

runs:
  using: 'composite'
  steps:
    - name: Setup Nu shell
      # v3.17
      uses: hustcer/setup-nu@920172d92eb04671776f3ba69d605d3b09351c30
      with:
        version: '0.110.0'

    - name: Run command
      id: run
      shell: nu {0}
      working-directory: ${{ inputs.working-directory }}
      run: |
        $env.NU_LIB_DIRS = [$"($env.GITHUB_ACTION_PATH)/scripts"]
        nu $"($env.GITHUB_ACTION_PATH)/scripts/dispatch.nu"
      env:
        GITHUB_ACTION_PATH: ${{ github.action_path }}
        # All inputs passed as INPUT_* environment variables
        INPUT_COMMAND: ${{ inputs.command }}
        INPUT_VERSION: ${{ inputs.version }}
        INPUT_TARGET: ${{ inputs.target }}
        INPUT_BINARY_NAME: ${{ inputs.binary-name }}
        INPUT_PACKAGE: ${{ inputs.package }}
        INPUT_MANIFEST: ${{ inputs.manifest }}
        INPUT_PRE_BUILD: ${{ inputs.pre-build }}
        INPUT_SKIP_BUILD: ${{ inputs.skip-build }}
        INPUT_BINARY_PATH: ${{ inputs.binary-path }}
        INPUT_FEATURES: ${{ inputs.features }}
        INPUT_PROFILE: ${{ inputs.profile }}
        INPUT_LOCKED: ${{ inputs.locked }}
        INPUT_NO_DEFAULT_FEATURES: ${{ inputs.no-default-features }}
        INPUT_RUSTFLAGS: ${{ inputs.rustflags }}
        INPUT_USE_ZIGBUILD: ${{ inputs.use-zigbuild }}
        INPUT_ARCHIVE: ${{ inputs.archive }}
        INPUT_CHECKSUM: ${{ inputs.checksum }}
        INPUT_INCLUDE: ${{ inputs.include }}
        INPUT_CHANGELOG: ${{ inputs.changelog }}
        INPUT_NOTES_OUTPUT: ${{ inputs.notes-output }}
        INPUT_TAG: ${{ inputs.tag }}
        INPUT_EXPECTED_VERSION: ${{ inputs.expected-version }}
        INPUT_VALIDATE_CARGO_TOML: ${{ inputs.validate-cargo-toml }}
        INPUT_PKG_DESCRIPTION: ${{ inputs.pkg-description }}
        INPUT_PKG_MAINTAINER: ${{ inputs.pkg-maintainer }}
        INPUT_PKG_HOMEPAGE: ${{ inputs.pkg-homepage }}
        INPUT_PKG_LICENSE: ${{ inputs.pkg-license }}
        INPUT_PKG_VENDOR: ${{ inputs.pkg-vendor }}
        INPUT_PKG_DEPENDS: ${{ inputs.pkg-depends }}
        INPUT_PKG_RECOMMENDS: ${{ inputs.pkg-recommends }}
        INPUT_PKG_SUGGESTS: ${{ inputs.pkg-suggests }}
        INPUT_PKG_CONFLICTS: ${{ inputs.pkg-conflicts }}
        INPUT_PKG_REPLACES: ${{ inputs.pkg-replaces }}
        INPUT_PKG_PROVIDES: ${{ inputs.pkg-provides }}
        INPUT_PKG_CONTENTS: ${{ inputs.pkg-contents }}
        INPUT_PKG_SECTION: ${{ inputs.pkg-section }}
        INPUT_PKG_PRIORITY: ${{ inputs.pkg-priority }}
        INPUT_PKG_GROUP: ${{ inputs.pkg-group }}
        INPUT_PKG_RELEASE: ${{ inputs.pkg-release }}
        INPUT_SBOM_FORMAT: ${{ inputs.sbom-format }}
        INPUT_SBOM_DIR: ${{ inputs.sbom-dir }}
        INPUT_BREW_CLASS: ${{ inputs.brew-class }}
        INPUT_BREW_MACOS_ARM64_URL: ${{ inputs.brew-macos-arm64-url }}
        INPUT_BREW_MACOS_ARM64_SHA256: ${{ inputs.brew-macos-arm64-sha256 }}
        INPUT_BREW_MACOS_X64_URL: ${{ inputs.brew-macos-x64-url }}
        INPUT_BREW_MACOS_X64_SHA256: ${{ inputs.brew-macos-x64-sha256 }}
        INPUT_BREW_LINUX_ARM64_URL: ${{ inputs.brew-linux-arm64-url }}
        INPUT_BREW_LINUX_ARM64_SHA256: ${{ inputs.brew-linux-arm64-sha256 }}
        INPUT_BREW_LINUX_X64_URL: ${{ inputs.brew-linux-x64-url }}
        INPUT_BREW_LINUX_X64_SHA256: ${{ inputs.brew-linux-x64-sha256 }}
        INPUT_BREW_DIR: ${{ inputs.brew-dir }}
        INPUT_ARTIFACT: ${{ inputs.artifact }}
        INPUT_ARTIFACTS_DIR: ${{ inputs.artifacts-dir }}
        INPUT_BASE_URL: ${{ inputs.base-url }}
        INPUT_NOTES_FILE: ${{ inputs.notes-file }}
        INPUT_INCLUDE_CHECKSUMS: ${{ inputs.include-checksums }}
        INPUT_INCLUDE_SIGNATURES: ${{ inputs.include-signatures }}
        INPUT_HOMEBREW_TAP: ${{ inputs.homebrew-tap }}
        INPUT_AUR_PACKAGE: ${{ inputs.aur-package }}
        INPUT_WINGET_ID: ${{ inputs.winget-id }}
        INPUT_AUR_NAME: ${{ inputs.aur-name }}
        INPUT_AUR_MAINTAINER: ${{ inputs.aur-maintainer }}
        INPUT_AUR_SOURCE_URL: ${{ inputs.aur-source-url }}
        INPUT_AUR_SOURCE_SHA256: ${{ inputs.aur-source-sha256 }}
        INPUT_AUR_MAKEDEPENDS: ${{ inputs.aur-makedepends }}
        INPUT_AUR_OPTDEPENDS: ${{ inputs.aur-optdepends }}
        INPUT_AUR_DIR: ${{ inputs.aur-dir }}
        INPUT_WINGET_PUBLISHER: ${{ inputs.winget-publisher }}
        INPUT_WINGET_PUBLISHER_ID: ${{ inputs.winget-publisher-id }}
        INPUT_WINGET_PACKAGE_ID: ${{ inputs.winget-package-id }}
        INPUT_WINGET_LICENSE_URL: ${{ inputs.winget-license-url }}
        INPUT_WINGET_COPYRIGHT: ${{ inputs.winget-copyright }}
        INPUT_WINGET_TAGS: ${{ inputs.winget-tags }}
        INPUT_WINGET_X64_URL: ${{ inputs.winget-x64-url }}
        INPUT_WINGET_X64_SHA256: ${{ inputs.winget-x64-sha256 }}
        INPUT_WINGET_ARM64_URL: ${{ inputs.winget-arm64-url }}
        INPUT_WINGET_ARM64_SHA256: ${{ inputs.winget-arm64-sha256 }}
        INPUT_WINGET_DIR: ${{ inputs.winget-dir }}
        INPUT_CHECKSUM_FILE: ${{ inputs.checksum-file }}
        INPUT_MSI_PATH: ${{ inputs.msi-path }}
        INPUT_MSI_CHECKSUM_FILE: ${{ inputs.msi-checksum-file }}
        INPUT_DOWNLOAD_FROM_RELEASE: ${{ inputs.download-from-release }}
        INPUT_ARCH: ${{ inputs.arch }}
